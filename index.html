<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>TCL Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        /* --- BEAUTIFUL UI STYLE --- */
        :root { --primary: #F05A28; --bg: #f2f4f7; --glass: rgba(255,255,255,0.95); }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); padding-bottom: 90px; }
        
        .app-header { background: linear-gradient(135deg, #004e92, #000428); color: white; padding: 15px 20px 30px; border-radius: 0 0 25px 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        
        .glass-card { background: white; border-radius: 16px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        
        .kpi-mini { padding: 10px; border-radius: 12px; background: #f8f9fa; border-left: 4px solid #ccc; height: 100%; }
        .kpi-val { font-size: 1.3rem; font-weight: bold; line-height: 1.2; }
        .kpi-lbl { font-size: 0.8rem; color: #666; }

        .btm-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(10px); border-radius: 50px; padding: 10px 20px; display: flex; justify-content: space-around; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .nav-item { color: #888; text-align: center; font-size: 0.7rem; cursor: pointer; transition: 0.3s; }
        .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 2px; }
        .nav-item.active { color: #fff; transform: translateY(-3px); }
        .nav-item.active i { color: var(--primary); }

        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .spinner-custom { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Helpers */
        .text-pos { color: #198754 !important; }
        .text-neg { color: #dc3545 !important; }
        .chart-box { height: 250px; position: relative; }
        
        /* Pills */
        .nav-pills .nav-link { border-radius: 20px; font-size: 0.85rem; color: #555; background: #fff; border: 1px solid #eee; padding: 5px 12px; margin-right: 5px; }
        .nav-pills .nav-link.active { background: #004e92; color: white; border-color: #004e92; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner-custom mb-2"></div>
        <div class="text-muted small">Loading...</div>
    </div>

    <div class="app-header sticky-top">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <div class="fw-bold fs-5">TCL Monitor</div>
                <div class="small opacity-75" id="header-date">-</div>
            </div>
            <button class="btn btn-light btn-sm rounded-circle shadow-sm" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasFilter">
                <i class="bi bi-calendar4-range text-primary"></i>
            </button>
        </div>
    </div>

    <div class="container-fluid px-3 pt-3">

        <div id="view-overview" class="view-section">
            
            <div class="d-flex gap-2 mb-3 overflow-auto pb-1">
                <select id="local-div" class="form-select form-select-sm shadow-sm rounded-pill" style="min-width:110px" onchange="applyLocalOverviewFilter()">
                    <option value="All">ทุกภาค/กอง</option>
                </select>
                <div class="d-flex" id="type-pills">
                    <button class="btn btn-sm btn-light border rounded-pill me-1 active" onclick="setOverviewType('All', this)">ทั้งหมด</button>
                    <button class="btn btn-sm btn-light border rounded-pill me-1" onclick="setOverviewType('ค่าโดยสาร', this)">โดยสาร</button>
                    <button class="btn btn-sm btn-light border rounded-pill" onclick="setOverviewType('ค่าพัสดุ', this)">พัสดุ</button>
                </div>
            </div>

            <div class="row g-2 mb-3">
                <div class="col-6"><div class="kpi-mini" style="border-left-color: #0d6efd;"><div class="kpi-lbl">รายได้</div><div class="kpi-val text-primary" id="kpi-rev">0</div></div></div>
                <div class="col-6"><div class="kpi-mini" style="border-left-color: #ffc107;"><div class="kpi-lbl">เป้าหมาย</div><div class="kpi-val text-warning" id="kpi-target">0</div></div></div>
                <div class="col-12">
                    <div class="glass-card d-flex justify-content-between align-items-center py-2 px-3 mb-0" id="kpi-card-diff">
                        <div><div class="kpi-lbl">ส่วนต่าง</div><div class="fw-bold fs-5" id="kpi-diff">0</div></div>
                        <div class="text-end"><div class="fw-bold fs-4" id="kpi-pct">0%</div></div>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <h6 class="fw-bold text-secondary mb-3">แนวโน้มรายวัน</h6>
                <div class="chart-box"><canvas id="chart-trend"></canvas></div>
            </div>

            <div class="glass-card">
                <div class="d-flex justify-content-between mb-2">
                    <h6 class="fw-bold text-secondary" id="ranking-title">Top 15</h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="toggleRank('pct')">%</button>
                        <button class="btn btn-outline-secondary active" onclick="toggleRank('top')">Top</button>
                        <button class="btn btn-outline-secondary" onclick="toggleRank('low')">Low</button>
                    </div>
                </div>
                <div class="chart-box" style="height:350px"><canvas id="chart-rank"></canvas></div>
            </div>

            <div class="glass-card p-0 overflow-hidden">
                <div class="p-2 bg-light border-bottom fw-bold small text-secondary">รายการล่าสุด</div>
                <div class="table-responsive" style="max-height:300px">
                    <table class="table table-sm table-striped mb-0" style="font-size:0.85rem">
                        <tbody id="table-overview"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-compare" class="view-section" style="display:none">
            <h5 class="fw-bold text-secondary mb-3">เปรียบเทียบย้อนหลัง</h5>
            <div class="glass-card">
                <div class="row g-2">
                    <div class="col-6"><small>ภาค</small><select id="cp-div" class="form-select form-select-sm"><option value="All">ทั้งหมด</option></select></div>
                    <div class="col-6"><small>ประเภท</small><select id="cp-type" class="form-select form-select-sm"><option value="All">ทั้งหมด</option></select></div>
                    <div class="col-12"><small>ช่วงเวลา</small><select id="cp-days" class="form-select form-select-sm"><option value="7" selected>7 วันล่าสุด</option><option value="15">15 วันล่าสุด</option><option value="30">30 วันล่าสุด</option></select></div>
                    <div class="col-12 mt-2"><button class="btn btn-primary w-100 rounded-pill" onclick="loadCompare()">ประมวลผล</button></div>
                </div>
            </div>
            <div id="compare-result" class="glass-card" style="display:none">
                <div class="chart-box" style="height:400px"><canvas id="chart-compare"></canvas></div>
            </div>
        </div>

        <div id="view-detail" class="view-section" style="display:none">
            <h5 class="fw-bold text-secondary mb-3">ค้นหาเจาะลึก</h5>
            <div class="glass-card">
                <div class="row g-2">
                    <div class="col-12"><small>สถานี</small><select id="dt-station" class="form-select form-select-sm"></select></div>
                    <div class="col-6"><small>เริ่ม</small><input type="date" id="dt-start" class="form-control form-control-sm"></div>
                    <div class="col-6"><small>สิ้นสุด</small><input type="date" id="dt-end" class="form-control form-control-sm"></div>
                    <div class="col-12 mt-2"><button class="btn btn-info text-white w-100 rounded-pill" onclick="loadDetail()">ค้นหา</button></div>
                </div>
            </div>
            <div id="detail-result" class="glass-card p-0" style="display:none">
                <div class="table-responsive" style="max-height:500px">
                    <table class="table table-sm table-hover mb-0" style="font-size:0.85rem">
                        <thead class="table-light sticky-top"><tr><th>วันที่</th><th>ชื่อ</th><th>ประเภท</th><th class="text-end">รายได้</th></tr></thead>
                        <tbody id="dt-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="offcanvas offcanvas-bottom rounded-top-4" style="height:auto" tabindex="-1" id="offcanvasFilter">
        <div class="offcanvas-header"><h5 class="offcanvas-title fw-bold">เลือกเดือนข้อมูล</h5><button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button></div>
        <div class="offcanvas-body">
            <div class="row g-2">
                <div class="col-6"><label>ปี</label><select id="ov-year" class="form-select"></select></div>
                <div class="col-6"><label>เดือน</label><select id="ov-month" class="form-select"></select></div>
                <div class="col-12 mt-3"><button class="btn btn-primary w-100 rounded-pill" onclick="reloadOverviewData()">โหลดข้อมูล</button></div>
            </div>
        </div>
    </div>

    <div class="btm-nav">
        <div class="nav-item active" onclick="switchTab('overview', this)"><i class="bi bi-grid-fill"></i>ภาพรวม</div>
        <div class="nav-item" onclick="switchTab('compare', this)"><i class="bi bi-bar-chart-line-fill"></i>เทียบ</div>
        <div class="nav-item" onclick="switchTab('detail', this)"><i class="bi bi-search"></i>เจาะลึก</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // --- SETUP ---
        const API_URL = "https://script.google.com/macros/s/AKfycbwOwP-6GXY91XjKt-i5MlkKvimDhSRbcDQjcDupuuI3XlHyLv4R3WGcNYcKjW41Bqll4w/exec"; 
        const API_KEY = "olXRtf48PTPC2xPvWRijfiooIiQCElQqQBdCeHlVhvVYWxpob1Az8uQol9Nc"; // ต้องตรงกับ GAS

        let fullMeta = [], overviewCache = [];
        let currentOvType = 'All';
        let charts = {};
        let filterCanvas;

        window.onload = async function() {
            filterCanvas = new bootstrap.Offcanvas('#offcanvasFilter');
            const d = new Date();
            const months = ["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."];
            document.getElementById('header-date').innerText = `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()+543}`;
            
            // Default Dates for local filter
            let y = d.getFullYear(), m = d.getMonth();
            // document.getElementById('local-start').valueAsDate = new Date(y, m, 1, 12); // ถ้าจะใช้ local date range
            
            await initMetadata();
        };

        // --- API CALLER ---
        async function callApi(funcName, paramsObj = {}) {
            const url = new URL(API_URL);
            url.searchParams.append('key', API_KEY);
            url.searchParams.append('func', funcName);
            
            // Convert params to fit original signatures
            // Original functions expect specific arguments, we mapped them in GAS doGet
            if (funcName === 'getOverviewData' || funcName === 'getDetailDataMultiSource') {
                url.searchParams.append('criteria', JSON.stringify(paramsObj));
            } else if (funcName === 'getCompareData') {
                url.searchParams.append('days', paramsObj.days);
                url.searchParams.append('criteria', JSON.stringify(paramsObj.criteria));
            }

            try {
                const res = await fetch(url);
                const json = await res.json();
                if(json.status === 'error') throw new Error(json.message);
                return json;
            } catch (e) {
                console.error(e);
                Swal.fire('Error', e.message, 'error');
                return null;
            }
        }

        // --- LOGIC ---
        async function initMetadata() {
            document.getElementById('loader').style.display='flex';
            const data = await callApi('getMetadata');
            if(data) {
                fullMeta = data.meta;
                fillSelect('cp-type', data.types);
                fillSelect('cp-div', data.divisions);
                
                // Fill Local Div Filter
                let localDiv = document.getElementById('local-div');
                data.divisions.forEach(d => { let opt=document.createElement('option'); opt.value=d; opt.text=d; localDiv.add(opt); });

                let stations = [...new Set(fullMeta.map(m=>m.s))].sort();
                fillSelect('dt-station', stations);

                let years = [...new Set(fullMeta.map(m=>m.y))];
                let months = [...new Set(fullMeta.map(m=>m.m))];
                updateSelect('ov-year', years, new Date().getFullYear());
                updateSelect('ov-month', months, new Date().getMonth()+1);

                await reloadOverviewData();
            }
            document.getElementById('loader').style.display='none';
        }

        async function reloadOverviewData() {
            document.getElementById('loader').style.display='flex';
            filterCanvas.hide();
            // Criteria เดิมจากโค้ดท่าน
            const criteria = { 
                group: 'Station', 
                division: 'All', 
                year: document.getElementById('ov-year').value, 
                month: document.getElementById('ov-month').value, 
                station: 'All' 
            };
            const data = await callApi('getOverviewData', criteria);
            if(data) {
                overviewCache = data;
                applyLocalOverviewFilter();
            }
            document.getElementById('loader').style.display='none';
        }

        function applyLocalOverviewFilter() {
            const fDiv = document.getElementById('local-div').value;
            // Logic กรอง division แบบ Local (ตามโค้ดเดิม)
            let filtered = overviewCache.filter(r => {
                let meta = fullMeta.find(m => m.s === r.station);
                let rowDiv = meta ? meta.d : 'Unknown';
                return (fDiv === 'All') || (rowDiv === fDiv);
            });
            updateOverviewUI(filtered);
        }

        function setOverviewType(type, btn) {
            currentOvType = type;
            // Update UI Active State
            let btns = document.getElementById('type-pills').getElementsByTagName('button');
            for(let b of btns) b.classList.remove('active');
            btn.classList.add('active');
            applyLocalOverviewFilter();
        }

        function updateOverviewUI(data) {
            // Logic เดิม: กรอง RevType ที่นี่
            let finalData = data.filter(r => currentOvType === 'All' || r.revType.includes(currentOvType));

            let rev=0, target=0;
            finalData.forEach(r => { rev+=r.revenue; target+=r.target; });
            let diff = rev - target;
            let pct = target>0 ? ((diff/target)*100) : 0;

            document.getElementById('kpi-rev').innerText = formatCurrency(rev);
            document.getElementById('kpi-target').innerText = formatCurrency(target);
            document.getElementById('kpi-diff').innerText = formatCurrency(diff);
            document.getElementById('kpi-pct').innerText = (diff>=0?'+':'') + pct.toFixed(1) + '%';

            let diffCard = document.getElementById('kpi-card-diff');
            if(diff>=0) { diffCard.className = "glass-card d-flex justify-content-between align-items-center py-2 px-3 mb-0 text-pos"; }
            else { diffCard.className = "glass-card d-flex justify-content-between align-items-center py-2 px-3 mb-0 text-neg"; }

            renderTrend(finalData);
            toggleRank('top', finalData);
            renderTable(finalData);
        }

        // --- CHARTS & RENDERERS (Adapting same logic) ---
        function renderTrend(data) {
            let daily = {}; data.forEach(r => daily[r.day] = (daily[r.day]||0)+r.revenue);
            let labels = Object.keys(daily).sort((a,b)=>a-b);
            let ctx = document.getElementById('chart-trend').getContext('2d');
            if(charts.trend) charts.trend.destroy();
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets:[{ label:'Revenue', data:labels.map(x=>daily[x]), borderColor:'#0d6efd', backgroundColor:'rgba(13,110,253,0.1)', fill:true, tension:0.4 }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{ticks:{callback:v=>v/1000+'k'}}} }
            });
        }

        function toggleRank(mode, dataOverride) {
            let src = dataOverride || overviewCache.filter(r => currentOvType === 'All' || r.revType.includes(currentOvType));
            let stats = {}; src.forEach(r => { 
                let clean = cleanStationName(r.station);
                if(!stats[clean]) stats[clean] = {rev:0, target:0}; 
                stats[clean].rev += r.revenue; stats[clean].target += r.target;
            });
            let items = Object.entries(stats).map(([k,v]) => ({
                name:k, rev:v.rev, 
                pct: v.target>0 ? ((v.rev-v.target)/v.target*100) : -100
            }));

            if(mode==='pct') { items.sort((a,b) => b.pct - a.pct); document.getElementById('ranking-title').innerText="Top %"; }
            else if(mode==='top') { items.sort((a,b) => b.rev - a.rev); document.getElementById('ranking-title').innerText="Top Rev"; }
            else { items.sort((a,b) => a.rev - b.rev); document.getElementById('ranking-title').innerText="Low Rev"; }

            items = items.slice(0, 15);
            let ctx = document.getElementById('chart-rank').getContext('2d');
            if(charts.rank) charts.rank.destroy();
            charts.rank = new Chart(ctx, {
                type: 'bar',
                data: { labels: items.map(x=>x.name), datasets:[{ label: mode==='pct'?'%':'Rev', data: items.map(x=>mode==='pct'?x.pct:x.rev), backgroundColor: mode==='top'?'#0d6efd':(mode==='pct'?'#198754':'#dc3545'), borderRadius:4 }] },
                options: { indexAxis: 'y', responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}} }
            });
        }

        function renderTable(data) {
            let tbody = document.getElementById('table-overview'); tbody.innerHTML='';
            data.slice(0,30).forEach(r => {
                let color = r.revenue>=r.target ? 'text-success':'text-danger';
                tbody.innerHTML += `<tr><td>${r.day}</td><td>${cleanStationName(r.station)}</td><td class="text-end text-muted">${formatK(r.target)}</td><td class="text-end fw-bold ${color}">${formatCurrency(r.revenue)}</td></tr>`;
            });
        }

        async function loadCompare() {
            document.getElementById('loader').style.display='flex';
            let crit = { group: 'Station', division: document.getElementById('cp-div').value, type: document.getElementById('cp-type').value };
            let days = document.getElementById('cp-days').value;
            let data = await callApi('getCompareData', { days: days, criteria: crit });
            
            document.getElementById('compare-result').style.display='block';
            let ctx = document.getElementById('chart-compare').getContext('2d');
            if(charts.compare) charts.compare.destroy();
            charts.compare = new Chart(ctx, {
                type: 'bar',
                data: { labels: data.slice(0,15).map(x=>cleanStationName(x.station)), datasets:[{label:'Rev', data:data.slice(0,15).map(x=>x.revenue), backgroundColor:'#0d6efd'}] },
                options: { indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
            });
            document.getElementById('loader').style.display='none';
        }

        async function loadDetail() {
            let st = document.getElementById('dt-station').value;
            if(!st) return;
            document.getElementById('loader').style.display='flex';
            let crit = { division:'All', station:st, start:document.getElementById('dt-start').value, end:document.getElementById('dt-end').value };
            let data = await callApi('getDetailDataMultiSource', crit);
            
            document.getElementById('detail-result').style.display='block';
            let tbody = document.getElementById('dt-tbody'); tbody.innerHTML='';
            if(data) {
                data.forEach(r => {
                    tbody.innerHTML += `<tr><td>${new Date(r.date).getDate()}/${new Date(r.date).getMonth()+1}</td><td>${r.name}</td><td>${r.revType}</td><td class="text-end fw-bold">${formatCurrency(r.revenue)}</td></tr>`;
                });
            }
            document.getElementById('loader').style.display='none';
        }

        // --- UTILS ---
        function switchTab(tab, el) {
            document.querySelectorAll('.view-section').forEach(x=>x.style.display='none');
            document.getElementById('view-'+tab).style.display='block';
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
            el.classList.add('active');
            window.scrollTo(0,0);
        }
        function cleanStationName(name) { return name.replace('สถานีเดินรถ','').replace('สถานี','').trim(); }
        function formatCurrency(n) { return n.toLocaleString('th-TH', {minimumFractionDigits:0, maximumFractionDigits:0}); }
        function formatK(n) { return n>=1000?(n/1000).toFixed(0)+'k':n; }
        function fillSelect(id, items) { let el=document.getElementById(id); items.forEach(v=>{let o=document.createElement('option'); o.value=v; o.text=v; el.add(o);}); }
        function updateSelect(id, items, cur) { let el=document.getElementById(id); el.innerHTML=''; items.sort((a,b)=>b-a).forEach(v=>{let o=document.createElement('option'); o.value=v; o.text=v; el.add(o);}); if(cur) el.value=cur; }
    </script>
</body>
</html>
